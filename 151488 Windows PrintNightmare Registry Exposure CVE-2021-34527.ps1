##Written by A1C Logan Houston 366CS##
#For more information regarding this fix search KB5005652 and KB5005010 help topic on microsoft

#creates a log saved at C:\temp\Script.log
$test = test-path -path "C:\Temp" 
if ($test -eq $true) {}
Else {New-Item -Path "c:\" -Name "Temp" -ItemType "directory"}
Start-Transcript -Path C:\temp\Script.log
Write-Host "Creating Log File at C:\temp\Script.log"

#Runs script against all the computers in a list
$Computers = Get-Content "Filepath Here"
$total = $computers.count 
$x = 0
foreach ($Computer in $Computers) {
$percentage = ($x / $total)*100
write-progress -Activity "Progress" -Status $Computer -PercentComplete $percentage
#Get-Service -ComputerName $Computer -ServiceName WinRM | Start-Service
Invoke-Command -Computername $computer -ScriptBlock {


#checks if the key already exists, changes it to the correct configuration or creates if it doesnt exist
$test = test-path -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint\RestrictDriverInstallationToAdministrators" 
if ($test -eq $true) {Set-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -name "RestrictDriverInstallationToAdministrators" -value 1 -Force | Out-null}

Else {
md 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint'
New-ItemProperty -path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint' -name 'RestrictDriverInstallationToAdministrators' -value '1' -PropertyType 'DWord' -Force | Out-Null}

}
$x++
}
Stop-Transcript